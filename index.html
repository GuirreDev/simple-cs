<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Simple CS: Online</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        /* === ESTILOS GENERALES === */
        body { 
            margin: 0; 
            overflow: hidden; 
            background: #000; 
            font-family: 'Arial', sans-serif; 
            color: white; 
            user-select: none; 
        }

        /* Contenedor del juego */
        #game-wrapper { 
            position: relative; 
            width: 100vw; 
            height: 100vh; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            background: #111;
        }

        canvas { 
            background: #222;
            box-shadow: 0 0 50px rgba(0,0,0,0.8); 
            border-radius: 4px; 
            cursor: crosshair; 
        }
        
        /* === MENÚ PRINCIPAL (CORREGIDO) === */
        #menu-screen { 
            position: fixed; /* Asegura que esté fijo en la pantalla */
            top: 0; left: 0; 
            width: 100%; height: 100%; 
            background: rgba(10, 10, 10, 0.95); /* Fondo oscuro casi opaco */
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            z-index: 9999; /* Capa superior absoluta */
        }
        
        /* === ELEMENTOS UI === */
        .hidden { display: none !important; }
        
        h1 { 
            font-size: 80px; 
            margin: 0 0 40px 0; 
            color: #ff9900; 
            text-transform: uppercase; 
            letter-spacing: 5px; 
            text-shadow: 0 0 20px rgba(255, 153, 0, 0.5);
        }

        .panel { 
            background: #222; 
            padding: 40px; 
            border-radius: 15px; 
            border: 2px solid #ff9900; 
            text-align: center; 
            min-width: 300px;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
        }

        /* Botones muy visibles */
        .btn { 
            display: block;
            width: 100%;
            background: #ff9900; 
            color: black; 
            border: none; 
            padding: 15px 0; 
            font-size: 20px; 
            font-weight: bold; 
            cursor: pointer; 
            margin: 10px 0; 
            border-radius: 8px; 
            transition: transform 0.1s;
        }
        .btn:hover { transform: scale(1.05); background: #ffaa33; }
        
        .btn-secondary { background: #444; color: white; }
        .btn-secondary:hover { background: #555; }

        input { 
            padding: 15px; 
            font-size: 18px; 
            width: 90%; 
            margin-bottom: 20px; 
            text-align: center;
            border-radius: 5px;
            border: 1px solid #555;
            background: #111;
            color: white;
        }

        /* === HUD (Interfaz de juego) === */
        #hud { 
            position: absolute; 
            top: 0; left: 0; 
            width: 100%; height: 100%; 
            pointer-events: none; 
            z-index: 50; 
        }

        #top-bar { 
            display: flex; 
            justify-content: space-between; 
            padding: 20px; 
            font-size: 24px; 
            font-weight: bold; 
            text-shadow: 2px 2px 0 #000;
        }

        .team-blue { color: #4facfe; } 
        .team-red { color: #ff5858; }

        #weapon-info {
            position: absolute;
            bottom: 30px;
            left: 30px;
            font-size: 20px;
            color: #ddd;
            background: rgba(0,0,0,0.6);
            padding: 10px 20px;
            border-left: 5px solid #ff9900;
        }
        
        #end-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 10000;
        }

        .waiting-text {
            background: #000;
            color: #0f0;
            font-family: monospace;
            padding: 10px;
            margin: 10px 0;
            border: 1px dashed #0f0;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <div id="menu-screen">
        <h1>SIMPLE CS</h1>
        
        <div class="panel" id="menu-main">
            <p style="color:#aaa; margin-bottom: 20px;">Shooter Táctico 2D con PeerJS</p>
            <button class="btn" onclick="setupHost()">CREAR PARTIDA</button>
            <button class="btn btn-secondary" onclick="showJoinMenu()">UNIRSE A PARTIDA</button>
        </div>

        <div class="panel hidden" id="menu-host">
            <h3>Tu ID de Partida</h3>
            <div class="waiting-text" id="my-peer-id" onclick="copyId()">Generando ID...</div>
            <p style="font-size: 12px; color: #888;">Copia este ID y pásaselo a tu amigo.</p>
            <button class="btn btn-secondary" onclick="location.reload()">CANCELAR</button>
        </div>

        <div class="panel hidden" id="menu-join">
            <h3>Unirse a Partida</h3>
            <input type="text" id="host-id-input" placeholder="Pega el ID aquí">
            <button class="btn" onclick="joinGame()">CONECTAR</button>
            <button class="btn btn-secondary" onclick="location.reload()">VOLVER</button>
        </div>
    </div>

    <div id="end-screen" class="hidden">
        <h1 id="winner-text">VICTORIA</h1>
        <button class="btn" onclick="location.reload()" style="width: 200px;">MENU</button>
    </div>

    <div id="game-wrapper">
        <canvas id="gameCanvas"></canvas>
        
        <div id="hud" class="hidden">
            <div id="top-bar">
                <div>AZUL: <span id="score-blue" class="team-blue">0</span></div>
                <div id="timer">02:30</div>
                <div>ROJO: <span id="score-red" class="team-red">0</span></div>
            </div>
            <div id="weapon-info">
                <div id="w-name" style="font-size:14px; color:#888;">GLOCK</div>
                <div id="w-ammo" style="font-size:24px;">12 / ∞</div>
            </div>
        </div>
    </div>

    <script>
        // === CONFIGURACIÓN ===
        const CONFIG = {
            width: 1024, height: 768,
            walkSpeed: 2.5, runSpeed: 4.5
        };

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = CONFIG.width;
        canvas.height = CONFIG.height;

        // Variables Globales
        let isHost = false;
        let peer = null, conn = null;
        let gameState = { active: false, players: [], bullets: [], walls: [], score: {b:0, r:0}, timer: 150, round: 1 };
        let localInput = { k: {}, m: {x:0, y:0, d:false}, w: 1 };
        let clientPlayer = null; // Para interpolación cliente

        // === MENÚS ===
        function showJoinMenu() {
            document.getElementById('menu-main').classList.add('hidden');
            document.getElementById('menu-join').classList.remove('hidden');
        }

        function copyId() {
            navigator.clipboard.writeText(document.getElementById('my-peer-id').innerText);
            alert("ID Copiado!");
        }

        // === RED (PEERJS) ===
        function setupHost() {
            document.getElementById('menu-main').classList.add('hidden');
            document.getElementById('menu-host').classList.remove('hidden');
            
            try {
                peer = new Peer();
                peer.on('open', id => {
                    document.getElementById('my-peer-id').innerText = id;
                });
                peer.on('connection', c => {
                    conn = c;
                    isHost = true;
                    startGameHost();
                });
                peer.on('error', err => alert("Error PeerJS: " + err));
            } catch(e) { alert("Error al cargar PeerJS. Revisa tu internet."); }
        }

        function joinGame() {
            const id = document.getElementById('host-id-input').value;
            if(!id) return;
            try {
                peer = new Peer();
                peer.on('open', myId => {
                    conn = peer.connect(id);
                    isHost = false;
                    startGameClient();
                });
            } catch(e) { alert("Error al conectar."); }
        }

        // === INICIO DEL JUEGO ===
        function startGameHost() {
            document.getElementById('menu-screen').classList.add('hidden');
            document.getElementById('hud').classList.remove('hidden');
            
            gameState.active = true;
            gameState.walls = [
                {x:0,y:0,w:1024,h:20}, {x:0,y:748,w:1024,h:20}, 
                {x:0,y:0,w:20,h:768}, {x:1004,y:0,w:20,h:768},
                {x:200,y:200,w:20,h:200}, {x:200,y:200,w:200,h:20},
                {x:600,y:500,w:200,h:20}, {x:800,y:400,w:20,h:120}
            ];
            
            startRound();
            
            // Loop de Host
            conn.on('data', data => { if(data.t === 'i') handleInput(data.p); });
            setInterval(gameLoopHost, 1000/60);
            setInterval(() => { if(gameState.active && gameState.timer > 0) gameState.timer--; }, 1000);
        }

        function startGameClient() {
            document.getElementById('menu-screen').classList.add('hidden');
            document.getElementById('hud').classList.remove('hidden');
            
            // Loop de Cliente
            conn.on('data', data => { 
                if(data.t === 's') {
                    gameState = data.p;
                    clientPlayer = gameState.players.find(p => p.id === 'c');
                    draw();
                    updateHUD();
                }
            });
            loopClient();
        }

        // === LÓGICA DE JUEGO (SIMPLIFICADA) ===
        function startRound() {
            gameState.players = [
                {id:'h', team:'b', x:100, y:384, hp:100, alive:true, w:1, ammo:12, ang:0}, // Host
                {id:'c', team:'r', x:900, y:384, hp:100, alive:true, w:1, ammo:12, ang:0}, // Client
                {id:'b1', team:'b', x:80, y:300, hp:100, alive:true, w:1, ammo:12, ang:0, bot:true},
                {id:'r1', team:'r', x:920, y:300, hp:100, alive:true, w:1, ammo:12, ang:0, bot:true}
            ];
            gameState.bullets = [];
            gameState.timer = 150;
        }

        function gameLoopHost() {
            if(!gameState.active) return;
            
            // Host Input
            let h = gameState.players[0];
            if(h.alive) applyMovement(h, localInput);

            // Bots AI
            gameState.players.forEach(p => {
                if(p.bot && p.alive) {
                    // IA tonta: moverse un poco
                    p.x += Math.sin(Date.now()/500)*1; 
                }
            });

            // Balas
            gameState.bullets.forEach((b, i) => {
                b.x += b.vx; b.y += b.vy;
                // Colisiones muy básicas
                gameState.players.forEach(p => {
                    if(p.team !== b.team && p.alive && Math.hypot(b.x-p.x, b.y-p.y) < 15) {
                        p.hp -= b.dmg;
                        if(p.hp<=0) p.alive = false;
                        gameState.bullets.splice(i, 1);
                    }
                });
            });

            // Enviar Estado
            conn.send({t:'s', p:gameState});
            draw();
            updateHUD();
        }

        function handleInput(inp) {
            let c = gameState.players[1];
            if(c && c.alive) applyMovement(c, inp);
        }

        function applyMovement(p, inp) {
            let s = inp.k['shift'] ? CONFIG.runSpeed : CONFIG.walkSpeed;
            if(inp.k['w']) p.y -= s;
            if(inp.k['s']) p.y += s;
            if(inp.k['a']) p.x -= s;
            if(inp.k['d']) p.x += s;
            p.ang = inp.m.a;
            p.w = inp.w;
            
            if(inp.m.d) shoot(p);
        }

        function shoot(p) {
            // Lógica simple de disparo (sin cooldown para brevedad, añade si quieres)
            if(Math.random() > 0.1) return; // Limitar cadencia hacky
            gameState.bullets.push({
                x:p.x, y:p.y, vx:Math.cos(p.ang)*15, vy:Math.sin(p.ang)*15, team:p.team, dmg:10
            });
        }

        function loopClient() {
            // Cliente solo manda inputs
            if(conn && conn.open) {
                conn.send({t:'i', p:{
                    k: localInput.k, 
                    m: {a: Math.atan2(localInput.m.y, localInput.m.x), d: localInput.m.d},
                    w: localInput.w
                }});
            }
            requestAnimationFrame(loopClient);
        }

        // === RENDERIZADO ===
        function draw() {
            // Fondo
            ctx.fillStyle = '#111';
            ctx.fillRect(0,0,canvas.width,canvas.height);

            // Paredes
            ctx.fillStyle = '#444';
            gameState.walls.forEach(w => ctx.fillRect(w.x,w.y,w.w,w.h));

            // Jugadores
            gameState.players.forEach(p => {
                if(!p.alive) return;
                ctx.save();
                ctx.translate(p.x, p.y);
                ctx.rotate(p.ang);
                ctx.fillStyle = p.team === 'b' ? '#4facfe' : '#ff5858';
                ctx.beginPath(); ctx.arc(0,0,12,0,Math.PI*2); ctx.fill();
                ctx.fillStyle = '#fff'; ctx.fillRect(5,-2,15,4); // Arma
                ctx.restore();
            });

            // Balas
            ctx.fillStyle = '#ff0';
            gameState.bullets.forEach(b => {
                ctx.beginPath(); ctx.arc(b.x,b.y,3,0,Math.PI*2); ctx.fill();
            });

            // LUZ (Transparente)
            let me = isHost ? gameState.players[0] : clientPlayer;
            if(me && me.alive) {
                ctx.save();
                // 1. Oscuridad
                ctx.fillStyle = 'rgba(0,0,0,0.95)';
                ctx.fillRect(0,0,canvas.width,canvas.height);
                // 2. Recorte (Luz)
                ctx.globalCompositeOperation = 'destination-out';
                let g = ctx.createRadialGradient(me.x, me.y, 20, me.x, me.y, 400);
                g.addColorStop(0, 'rgba(255,255,255,1)');
                g.addColorStop(1, 'rgba(255,255,255,0)');
                ctx.fillStyle = g;
                ctx.beginPath(); ctx.moveTo(me.x, me.y);
                ctx.arc(me.x, me.y, 400, me.ang - 0.5, me.ang + 0.5);
                ctx.lineTo(me.x, me.y);
                ctx.fill();
                ctx.restore();
            }
        }

        function updateHUD() {
            document.getElementById('score-blue').innerText = gameState.score.b;
            document.getElementById('score-red').innerText = gameState.score.r;
            let m = Math.floor(gameState.timer/60);
            let s = gameState.timer%60;
            document.getElementById('timer').innerText = `${m}:${s<10?'0'+s:s}`;
        }

        // === INPUTS ===
        window.addEventListener('keydown', e => {
            localInput.k[e.key.toLowerCase()] = true;
            if(e.key === '1') localInput.w = 0;
            if(e.key === '2') localInput.w = 1;
        });
        window.addEventListener('keyup', e => localInput.k[e.key.toLowerCase()] = false);
        canvas.addEventListener('mousemove', e => {
            let r = canvas.getBoundingClientRect();
            localInput.m.x = e.clientX - r.left;
            localInput.m.y = e.clientY - r.top;
        });
        canvas.addEventListener('mousedown', () => localInput.m.d = true);
        canvas.addEventListener('mouseup', () => localInput.m.d = false);

    </script>
</body>
</html>
