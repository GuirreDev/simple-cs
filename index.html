<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Simple CS: Tactical Update</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        /* ESTILOS (Mantenemos la base oscura y limpia) */
        body { margin: 0; overflow: hidden; background: #080808; font-family: 'Segoe UI', monospace; color: white; user-select: none; }
        #game-container { position: relative; width: 100vw; height: 100vh; display: flex; justify-content: center; align-items: center; }
        canvas { background: #181818; box-shadow: 0 0 50px rgba(0,0,0,0.5); border: 1px solid #333; }

        /* UI MENÚS */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .hidden { display: none !important; }

        h1 { font-size: 70px; color: #ff9d00; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 5px; text-shadow: 0 0 20px rgba(255, 157, 0, 0.4); }
        .box { background: #1e1e1e; padding: 40px; border: 1px solid #333; border-radius: 12px; text-align: center; min-width: 320px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        button { background: #ff9d00; color: #000; border: none; padding: 15px 30px; font-size: 18px; font-weight: bold; cursor: pointer; width: 100%; margin: 10px 0; border-radius: 4px; transition: 0.2s; }
        button:hover { background: #ffc107; transform: translateY(-2px); }
        button.secondary { background: #333; color: #fff; border: 1px solid #555; }
        button.secondary:hover { background: #444; }
        
        input[type="text"] { width: 90%; padding: 15px; text-align: center; background: #111; border: 1px solid #444; color: white; font-size: 16px; margin-bottom: 15px; border-radius: 4px; }
        
        /* Checkbox Switch */
        .toggle-container { display: flex; align-items: center; justify-content: space-between; margin: 15px 0; color: #aaa; font-size: 14px; background: #111; padding: 10px; border-radius: 4px; }
        input[type="checkbox"] { transform: scale(1.5); accent-color: #ff9d00; cursor: pointer; }

        .code-display { font-size: 20px; color: #0f0; background: #000; padding: 12px; border: 1px dashed #0f0; margin: 15px 0; cursor: pointer; word-break: break-all; }

        /* HUD */
        #hud { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        .top-bar { display: flex; justify-content: center; gap: 50px; padding: 25px; font-size: 32px; font-weight: 900; text-shadow: 2px 2px 0 #000; }
        .score-box { background: rgba(0,0,0,0.6); padding: 5px 20px; border-radius: 8px; border-top: 4px solid; display: flex; gap: 15px; }
        .s-blue { border-color: #4facfe; color: #4facfe; }
        .s-red { border-color: #ff5858; color: #ff5858; }
        .timer { font-family: monospace; color: #fff; background: #222; padding: 5px 15px; border-radius: 4px; border: 1px solid #444; }
        
        .hud-bottom { position: absolute; bottom: 30px; left: 30px; display: flex; align-items: flex-end; gap: 20px; }
        .hp-bar-container { width: 200px; height: 10px; background: #333; border-radius: 5px; overflow: hidden; margin-top: 5px;}
        .hp-fill { height: 100%; background: #0f0; transition: width 0.2s; }
        .hp-text { font-size: 24px; font-weight: bold; color: #fff; text-shadow: 1px 1px 0 #000; }
        
        .weapon-card { text-align: right; background: rgba(0,0,0,0.6); padding: 15px; border-right: 4px solid #ff9d00; border-radius: 4px; }
        .w-name { font-size: 14px; color: #888; text-transform: uppercase; letter-spacing: 1px; }
        .w-ammo { font-size: 36px; color: #fff; font-family: monospace; }
        
        /* Hit Marker (Extra) */
        #hit-marker { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 20px; height: 20px; pointer-events: none; opacity: 0; transition: opacity 0.1s; }
        #hit-marker::before, #hit-marker::after { content: ''; position: absolute; top: 9px; left: 0; width: 20px; height: 2px; background: #fff; transform: rotate(45deg); }
        #hit-marker::after { transform: rotate(-45deg); }
    </style>
</head>
<body>

    <div id="menu" class="overlay">
        <h1>SIMPLE CS</h1>
        <div class="box" id="menu-start">
            <div class="toggle-container">
                <span>INCLUIR BOTS (IA)</span>
                <input type="checkbox" id="chk-bots" checked>
            </div>
            <button onclick="setupHost()">CREAR PARTIDA</button>
            <button class="secondary" onclick="showJoin()">UNIRSE</button>
        </div>
        
        <div class="box hidden" id="menu-host">
            <p>TU CÓDIGO DE PARTIDA:</p>
            <div class="code-display" id="my-id" onclick="copyId()">Generando...</div>
            <p id="status-host" style="color: #ff9d00;">Esperando rival...</p>
        </div>

        <div class="box hidden" id="menu-join">
            <input type="text" id="host-id" placeholder="Pegar código del host">
            <button onclick="joinGame()">CONECTAR</button>
            <button class="secondary" onclick="location.reload()">ATRÁS</button>
        </div>
    </div>

    <div id="game-over" class="overlay hidden">
        <h1 id="winner-msg">VICTORIA</h1>
        <button onclick="location.reload()" style="width: 200px;">MENÚ</button>
    </div>

    <div id="game-container">
        <canvas id="canvas"></canvas>
        <div id="hit-marker"></div> <div id="hud" class="hidden">
            <div class="top-bar">
                <div class="score-box s-blue"><span id="score-b">0</span></div>
                <div class="timer" id="timer">02:30</div>
                <div class="score-box s-red"><span id="score-r">0</span></div>
            </div>
            
            <div class="hud-bottom">
                <div>
                    <div class="hp-text" id="hp-text">HP: 20</div>
                    <div class="hp-bar-container"><div class="hp-fill" id="hp-bar"></div></div>
                </div>
                <div class="weapon-card">
                    <div class="w-name" id="w-name">GLOCK</div>
                    <div class="w-ammo" id="w-ammo">12</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === 1. CONFIGURACIÓN & BALANCE ===
        const CONFIG = {
            width: 1280, height: 720,
            walkSpeed: 3, runSpeed: 5.5,
            maxHP: 20, // Vida reducida
            roundTime: 150, winScore: 7
        };

        const WEAPONS = [
            // ID 0: Subfusil
            { name: 'MP5', rate: 90, dmg: 2, speed: 22, auto: true, ammo: 30, color: '#333', w:8, h:24, unlock: 4 },
            // ID 1: Pistola
            { name: 'GLOCK', rate: 250, dmg: 2, speed: 22, auto: false, ammo: 12, color: '#555', w:6, h:16, unlock: 1 },
            // ID 2: Cuchillo
            { name: 'KNIFE', rate: 600, dmg: 10, speed: 0, auto: false, ammo: -1, color: '#ccc', w:4, h:14, unlock: 1 }
        ];

        // === 2. ESTADO DEL MOTOR ===
        let canvas = document.getElementById('canvas');
        let ctx = canvas.getContext('2d');
        canvas.width = CONFIG.width;
        canvas.height = CONFIG.height;

        let isHost = false, peer, conn;
        let useBots = true;
        
        let state = {
            active: false, round: 1, timer: CONFIG.roundTime,
            scores: { b: 0, r: 0 },
            players: [], bullets: [], walls: [], drops: [] // Nuevo array para loot
        };
        
        let input = { k: {}, m: {x:0, y:0, d:0}, w: 1 };
        let clientState = null; 
        let hitMarkerTime = 0;

        // === 3. RED (PEERJS) ===
        function setupHost() {
            useBots = document.getElementById('chk-bots').checked;
            document.getElementById('menu-start').classList.add('hidden');
            document.getElementById('menu-host').classList.remove('hidden');
            
            peer = new Peer();
            peer.on('open', id => document.getElementById('my-id').innerText = id);
            peer.on('connection', c => {
                conn = c; isHost = true;
                conn.send({type: 'config', useBots: useBots}); // Sincronizar config
                document.getElementById('status-host').innerText = "¡Conectado! Iniciando...";
                setTimeout(initGameHost, 1000);
            });
        }

        function showJoin() {
            document.getElementById('menu-start').classList.add('hidden');
            document.getElementById('menu-join').classList.remove('hidden');
        }

        function joinGame() {
            let id = document.getElementById('host-id').value;
            if(!id) return;
            peer = new Peer();
            peer.on('open', () => {
                conn = peer.connect(id);
                conn.on('data', d => {
                    if(d.type === 'config') useBots = d.useBots; // Recibir config del host
                    if(d.type === 'start') initGameClient();
                    if(d.type === 'state') clientState = d.payload;
                    if(d.type === 'hit') showHitMarker();
                    if(d.type === 'over') endGameUI(d.winner);
                });
            });
        }

        function copyId() {
            navigator.clipboard.writeText(document.getElementById('my-id').innerText);
            alert("ID Copiado");
        }

        // === 4. LÓGICA HOST ===
        function initGameHost() {
            uiStart();
            createMap();
            conn.send({type: 'start'});
            startRound();
            
            setInterval(gameLoop, 1000/60);
            setInterval(() => {
                if(state.active && state.timer > 0) state.timer--;
                if(state.active && state.timer <= 0) endRound('timeout');
            }, 1000);

            conn.on('data', d => { if(d.type === 'input') handleInput(1, d.payload); });
        }

        function createMap() {
            state.walls = [
                {x:0,y:0,w:CONFIG.width,h:20}, {x:0,y:CONFIG.height-20,w:CONFIG.width,h:20},
                {x:0,y:0,w:20,h:CONFIG.height}, {x:CONFIG.width-20,y:0,w:20,h:CONFIG.height},
                {x:300,y:200,w:20,h:320}, {x:300,y:200,w:200,h:20},
                {x:900,y:400,w:20,h:200}, {x:750,y:600,w:170,h:20},
                {x:550,y:300,w:100,h:100}, {x:600,y:100,w:20,h:100}
            ];
        }

        function startRound() {
            state.timer = CONFIG.roundTime;
            state.active = true;
            state.bullets = [];
            state.drops = []; // Limpiar items del suelo
            
            state.players = [
                newPlayer(0, 'b', 100, 360, false), // Host
                newPlayer(1, 'r', CONFIG.width-100, 360, false) // Client
            ];

            if(useBots) {
                state.players.push(newPlayer(2, 'b', 80, 200, true));
                state.players.push(newPlayer(3, 'b', 80, 520, true));
                state.players.push(newPlayer(4, 'r', CONFIG.width-80, 200, true));
                state.players.push(newPlayer(5, 'r', CONFIG.width-80, 520, true));
            }
        }

        function newPlayer(id, team, x, y, isBot) {
            return {
                id, team, x, y, isBot,
                hp: CONFIG.maxHP, alive: true,
                angle: 0, weapon: 1, ammo: 12, 
                lastShot: 0, animOffset: 0 // Para animación de disparo
            };
        }

        function gameLoop() {
            if(!state.active) return;
            
            handleInput(0, input);
            
            // IA Bots + Evitación de paredes
            state.players.forEach(p => { if(p.isBot && p.alive) updateBot(p); });

            // Balas
            state.bullets.forEach((b, i) => {
                b.x += b.vx; b.y += b.vy;
                
                // Colisión Paredes
                if(state.walls.some(w => rectCol(b.x, b.y, 4, 4, w.x, w.y, w.w, w.h)) || 
                   b.x<0 || b.x>CONFIG.width || b.y<0 || b.y>CONFIG.height) {
                    state.bullets.splice(i, 1); return;
                }

                // Colisión Jugadores
                for(let p of state.players) {
                    if(p.alive && p.team !== b.team && Math.hypot(p.x-b.x, p.y-b.y) < 18) {
                        p.hp -= b.dmg;
                        state.bullets.splice(i, 1);
                        
                        // Feedback al atacante
                        if(b.ownerId === 0) showHitMarker(); 
                        else if(b.ownerId === 1) conn.send({type:'hit'});

                        if(p.hp <= 0) {
                            p.alive = false;
                            // DROPEAR MUNICIÓN
                            state.drops.push({x: p.x, y: p.y, type: 'ammo'});
                            checkWin();
                        }
                        break;
                    }
                }
            });

            // Animación decay (recoil regresa a 0)
            state.players.forEach(p => p.animOffset *= 0.8);

            // Colisión con Drops (Mejora)
            state.players.forEach(p => {
                if(!p.alive) return;
                state.drops.forEach((d, i) => {
                    if(Math.hypot(p.x-d.x, p.y-d.y) < 20) {
                        // Evento: Recargar munición
                        p.ammo += 12; // Recarga cartucho
                        state.drops.splice(i, 1);
                    }
                });
            });

            if(conn && conn.open) conn.send({type: 'state', payload: state});
            render(state, 0);
            updateHUD(state, 0);
        }

        // === 5. FÍSICAS & IA AVANZADA ===
        function handleInput(pid, inp) {
            let p = state.players[pid];
            if(!p || !p.alive) return;

            let wId = inp.w;
            if(state.round < 4 && wId === 0) wId = 1; 
            p.weapon = wId;

            let s = inp.k.shift ? CONFIG.runSpeed : CONFIG.walkSpeed;
            let mx = (inp.k.d ? s : 0) - (inp.k.a ? s : 0);
            let my = (inp.k.s ? s : 0) - (inp.k.w ? s : 0);

            if(!wallCol(p.x + mx, p.y)) p.x += mx;
            if(!wallCol(p.x, p.y + my)) p.y += my;

            if(pid === 0) p.angle = Math.atan2(inp.m.y - p.y, inp.m.x - p.x);
            else p.angle = inp.m.a;

            if(inp.m.d) tryShoot(p);
        }

        function updateBot(bot) {
            // Buscar enemigo
            let target = state.players.find(p => p.team !== bot.team && p.alive && Math.hypot(p.x-bot.x, p.y-bot.y) < 800);
            
            if(target) {
                let desiredAngle = Math.atan2(target.y - bot.y, target.x - bot.x);
                let dist = Math.hypot(target.x - bot.x, target.y - bot.y);
                
                // Raycast "Bigotes" para evitar paredes
                let feelerX = bot.x + Math.cos(desiredAngle) * 40;
                let feelerY = bot.y + Math.sin(desiredAngle) * 40;
                
                if(wallCol(feelerX, feelerY)) {
                    // Si va a chocar, gira un poco
                    bot.angle += 0.15; 
                } else {
                    // Si no, apunta al enemigo
                    bot.angle = desiredAngle;
                }

                // Moverse
                if(dist > 200) {
                    let mx = Math.cos(bot.angle) * 3;
                    let my = Math.sin(bot.angle) * 3;
                    if(!wallCol(bot.x + mx, bot.y)) bot.x += mx;
                    if(!wallCol(bot.x, bot.y + my)) bot.y += my;
                }

                // Disparar
                if(dist < 500 && Math.random() < 0.02) tryShoot(bot);
            }
        }

        function tryShoot(p) {
            let w = WEAPONS[p.weapon];
            let now = Date.now();
            
            if(now - p.lastShot < w.rate) return;
            if(w.ammo !== -1 && p.ammo <= 0) return;

            p.lastShot = now;
            p.animOffset = 1; // Disparar animación

            if(w.ammo !== -1) p.ammo--;

            if(p.weapon === 2) { 
                // Melee (Cuchillo) - Animación es solo visual + hitbox corto
            } else {
                let spread = (Math.random() - 0.5) * 0.05;
                state.bullets.push({
                    x: p.x + Math.cos(p.angle)*20, 
                    y: p.y + Math.sin(p.angle)*20,
                    vx: Math.cos(p.angle + spread) * w.speed,
                    vy: Math.sin(p.angle + spread) * w.speed,
                    team: p.team, dmg: w.dmg, ownerId: p.id
                });
            }
        }

        // === 6. VISUALES (MODELOS Y ANIMACIONES) ===
        function initGameClient() {
            uiStart();
            loopClient();
        }

        function loopClient() {
            if(clientState) {
                render(clientState, 1);
                updateHUD(clientState, 1);
            }
            
            // Enviar Inputs
            if(conn && conn.open) {
                let r = canvas.getBoundingClientRect();
                let myP = clientState?.players[1];
                let ang = myP ? Math.atan2(input.m.y - myP.y, input.m.x - myP.x) : 0;
                
                conn.send({
                    type: 'input',
                    payload: { k: input.k, m: {x: input.m.x, y: input.m.y, a: ang, d: input.m.d}, w: input.w }
                });
            }
            requestAnimationFrame(loopClient);
        }

        function render(st, myId) {
            // Fondo limpio
            ctx.fillStyle = '#111';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Suelo (Grid sutil)
            ctx.strokeStyle = '#222'; ctx.lineWidth = 1;
            ctx.beginPath();
            for(let i=0; i<CONFIG.width; i+=50) { ctx.moveTo(i,0); ctx.lineTo(i,CONFIG.height); }
            for(let i=0; i<CONFIG.height; i+=50) { ctx.moveTo(0,i); ctx.lineTo(CONFIG.width,i); }
            ctx.stroke();

            // Drops (Mejoras en el suelo)
            st.drops.forEach(d => {
                ctx.fillStyle = '#0f0';
                ctx.fillRect(d.x-5, d.y-5, 10, 10);
                ctx.strokeStyle = '#fff';
                ctx.strokeRect(d.x-5, d.y-5, 10, 10);
                // Brillo
                ctx.shadowColor = '#0f0'; ctx.shadowBlur = 10;
                ctx.fill(); ctx.shadowBlur = 0;
            });

            // Paredes (Estilo sólido)
            ctx.fillStyle = '#2a2a2a';
            ctx.strokeStyle = '#444'; ctx.lineWidth = 2;
            st.walls.forEach(w => {
                ctx.fillRect(w.x, w.y, w.w, w.h);
                ctx.strokeRect(w.x, w.y, w.w, w.h);
            });

            // Balas (Trails)
            ctx.strokeStyle = '#ffffaa'; ctx.lineWidth = 2;
            st.bullets.forEach(b => {
                ctx.beginPath();
                ctx.moveTo(b.x, b.y);
                ctx.lineTo(b.x - b.vx, b.y - b.vy); // Trail basado en velocidad
                ctx.stroke();
            });

            // Jugadores
            st.players.forEach(p => {
                if(!p.alive) {
                    ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(p.angle);
                    ctx.fillStyle = '#420000'; // Sangre
                    ctx.beginPath(); ctx.arc(0,0,15,0,Math.PI*2); ctx.fill();
                    ctx.fillStyle = '#222'; // Cuerpo muerto
                    ctx.fillRect(-10,-10,20,20);
                    ctx.restore();
                    return;
                }

                ctx.save();
                ctx.translate(p.x, p.y);
                
                // Barra de Vida Aliada
                if(p.team === st.players[myId].team && p.id !== myId) {
                    ctx.fillStyle = '#0f0';
                    ctx.fillRect(-15, -25, 30 * (p.hp/CONFIG.maxHP), 4);
                }

                ctx.rotate(p.angle);

                // -- MODELO JUGADOR --
                // Hombros
                ctx.fillStyle = p.team === 'b' ? '#2980b9' : '#c0392b';
                ctx.beginPath(); ctx.arc(0, 0, 15, 0, Math.PI*2); ctx.fill();
                // Casco/Cabeza
                ctx.fillStyle = p.team === 'b' ? '#3498db' : '#e74c3c';
                ctx.beginPath(); ctx.arc(0, 0, 10, 0, Math.PI*2); ctx.fill();
                if(p.id === myId) { // Borde blanco para mi jugador
                    ctx.strokeStyle = '#fff'; ctx.lineWidth = 2; ctx.stroke();
                }

                // -- MODELO ARMA (TEXTURA PROCEDURAL) --
                let w = WEAPONS[p.weapon];
                let recoil = p.animOffset * 6; // Retroceso visual
                let stab = (p.weapon === 2) ? p.animOffset * 15 : 0; // Animación cuchillo

                ctx.save();
                ctx.translate(10 + stab - recoil, 5); // Posición mano derecha

                ctx.fillStyle = w.color;
                
                if(p.weapon === 0) { // SMG
                    ctx.fillRect(0, -2, 24, 6); // Cañon
                    ctx.fillStyle = '#111'; ctx.fillRect(5, 2, 4, 8); // Cargador
                    ctx.fillStyle = '#222'; ctx.fillRect(-5, -2, 8, 6); // Culata
                } else if (p.weapon === 1) { // Pistola
                    ctx.fillRect(0, -2, 16, 5);
                } else { // Cuchillo
                    ctx.fillStyle = '#5c4033'; ctx.fillRect(0, 0, 6, 4); // Mango
                    ctx.fillStyle = '#ddd'; ctx.beginPath(); ctx.moveTo(6,0); ctx.lineTo(16, 2); ctx.lineTo(6, 4); ctx.fill(); // Hoja
                }
                
                ctx.restore();
                
                // Manos
                ctx.fillStyle = '#f1c27d'; // Piel
                ctx.beginPath(); ctx.arc(10 - recoil + stab, 5, 4, 0, Math.PI*2); ctx.fill(); // Mano der
                if(p.weapon === 0) { ctx.beginPath(); ctx.arc(15 - recoil, -5, 4, 0, Math.PI*2); ctx.fill(); } // Mano izq (SMG)

                ctx.restore();
            });
        }

        // === 7. UI & UTILIDADES ===
        function updateHUD(st, myId) {
            document.getElementById('score-b').innerText = st.scores.b;
            document.getElementById('score-r').innerText = st.scores.r;
            
            let m = Math.floor(st.timer/60); let s = st.timer%60;
            document.getElementById('timer').innerText = `${m}:${s<10?'0'+s:s}`;

            let me = st.players[myId];
            if(me) {
                let w = WEAPONS[me.weapon];
                document.getElementById('w-name').innerText = w.name;
                document.getElementById('w-ammo').innerText = w.ammo === -1 ? '∞' : me.ammo;
                
                // Barra de vida propia
                document.getElementById('hp-text').innerText = `HP: ${Math.max(0, me.hp)}`;
                let pct = (Math.max(0, me.hp) / CONFIG.maxHP) * 100;
                let bar = document.getElementById('hp-bar');
                bar.style.width = pct + '%';
                bar.style.backgroundColor = pct < 30 ? '#f00' : '#0f0';
            }
        }

        function showHitMarker() {
            let el = document.getElementById('hit-marker');
            el.style.opacity = 1;
            setTimeout(() => el.style.opacity = 0, 100);
        }

        function uiStart() {
            document.getElementById('menu').classList.add('hidden');
            document.getElementById('hud').classList.remove('hidden');
        }

        function checkWin() {
            let bAlive = state.players.some(p => p.team === 'b' && p.alive);
            let rAlive = state.players.some(p => p.team === 'r' && p.alive);
            if(!bAlive) endRound('r');
            else if(!rAlive) endRound('b');
        }

        function endRound(winner) {
            state.active = false;
            if(winner === 'b') state.scores.b++;
            else if(winner === 'r') state.scores.r++;

            if(state.scores.b >= CONFIG.winScore || state.scores.r >= CONFIG.winScore) {
                let txt = winner === 'b' ? 'EQUIPO AZUL' : 'EQUIPO ROJO';
                conn.send({type: 'over', winner: txt});
                endGameUI(txt);
            } else {
                state.round++;
                setTimeout(startRound, 2500);
            }
        }

        function endGameUI(winner) {
            document.getElementById('game-over').classList.remove('hidden');
            document.getElementById('winner-msg').innerText = winner + " GANA";
        }

        // Utilidades Físicas
        function rectCol(x, y, w, h, rx, ry, rw, rh) { return x < rx + rw && x + w > rx && y < ry + rh && y + h > ry; }
        function wallCol(x, y) { return state.walls.some(w => x > w.x && x < w.x + w.w && y > w.y && y < w.y + w.h); }

        // Inputs
        window.addEventListener('keydown', e => {
            let k = e.key.toLowerCase();
            input.k[k] = true;
            if(k==='1') input.w = 0; if(k==='2') input.w = 1; if(k==='3') input.w = 2;
        });
        window.addEventListener('keyup', e => input.k[e.key.toLowerCase()] = false);
        window.addEventListener('mousedown', () => input.m.d = true);
        window.addEventListener('mouseup', () => input.m.d = false);
        window.addEventListener('mousemove', e => {
            let r = canvas.getBoundingClientRect();
            input.m.x = e.clientX - r.left; input.m.y = e.clientY - r.top;
        });

    </script>
</body>
</html>
